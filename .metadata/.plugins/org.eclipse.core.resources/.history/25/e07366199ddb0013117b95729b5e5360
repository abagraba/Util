import java.io.IOException;
import java.io.InputStream;

public class Chunker {

	private static byte[] size = new byte[4];
	private static byte[] header = new byte[4];
	private static byte[] crc = new byte[4];

	public static Chunk nextChunk(InputStream src) {
		readBytes(src, size);
		readBytes(src, header);
		int chunkSize = (size[0] << 24) + (size[1] << 16) + (size[2] << 8)
				+ size[3];
		byte[] chunkData = new byte[chunkSize];
		readBytes(src, chunkData);
		readBytes(src, crc);
		int crcval = (crc[0] << 24) + (crc[1] << 16) + (crc[2] << 8)
				+ crc[3];
		return new Chunk(chunkSize, header, chunkData, crcval);
	}

	public static void readBytes(InputStream src, byte[] data) throws IOException {
		int bytesRead = 0;
		while (bytesRead < data.length) {
			int i = src.read(data, bytesRead, data.length - bytesRead);
			if (i == -1) {
				System.err.println("Invalid Stream Read: Unexpected EOF.");
				System.exit(-1);
			}
			bytesRead += i;
		}
	}

}
